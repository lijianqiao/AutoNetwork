# é€šç”¨å¯¼å…¥å¯¼å‡ºæœåŠ¡ä½¿ç”¨è¯´æ˜

## æ¦‚è¿°

é€šç”¨å¯¼å…¥å¯¼å‡ºæœåŠ¡æä¾›äº†ä¸€å¥—å®Œæ•´çš„æ•°æ®å¯¼å…¥å¯¼å‡ºè§£å†³æ–¹æ¡ˆï¼Œæ”¯æŒExcelå’ŒCSVæ ¼å¼ï¼Œå…·å¤‡ä»¥ä¸‹ç‰¹æ€§ï¼š

- ğŸ”§ **æ¨¡æ¿ç”Ÿæˆ**: è‡ªåŠ¨ç”Ÿæˆå¸¦ç¤ºä¾‹æ•°æ®å’Œå­—æ®µè¯´æ˜çš„å¯¼å…¥æ¨¡æ¿
- ğŸ“Š **å¤šæ ¼å¼æ”¯æŒ**: æ”¯æŒ xlsx å’Œ csv æ ¼å¼
- ğŸ—ºï¸ **å­—æ®µæ˜ å°„**: ä¸­è‹±æ–‡å­—æ®µåæ˜ å°„ï¼Œæ”¯æŒè‡ªå®šä¹‰æ˜¾ç¤ºåç§°
- âœ… **æ•°æ®éªŒè¯**: è‡ªåŠ¨éªŒè¯æ•°æ®æ ¼å¼ã€å¿…å¡«å­—æ®µã€å”¯ä¸€æ€§ç­‰
- ğŸ”— **å¤–é”®å¤„ç†**: è‡ªåŠ¨åˆ›å»ºå…³è”æ•°æ®ï¼ˆå¦‚å‚å•†ã€åŸºåœ°ç­‰ï¼‰
- ğŸ“ **æ“ä½œæ—¥å¿—**: å®Œæ•´çš„å¯¼å…¥å¯¼å‡ºæ“ä½œè®°å½•

## æ ¸å¿ƒç»„ä»¶

### 1. BaseImportExportService

æŠ½è±¡åŸºç±»ï¼Œæä¾›é€šç”¨çš„å¯¼å…¥å¯¼å‡ºåŠŸèƒ½ï¼š

```python
from app.utils.import_export.base import BaseImportExportService, FieldMapping, ImportExportConfig

class MyImportExportService(BaseImportExportService):
    def __init__(self):
        # é…ç½®å­—æ®µæ˜ å°„
        field_mappings = [
            FieldMapping(
                field_name="name",
                display_name="åç§°",
                is_required=True,
                description="å¿…å¡«ï¼Œä¸èƒ½é‡å¤"
            ),
            # ... æ›´å¤šå­—æ®µ
        ]
        
        # é…ç½®å¯¼å…¥å¯¼å‡ºè§„åˆ™
        config = ImportExportConfig(
            model_name="MyModel",
            template_name="æˆ‘çš„æ¨¡æ¿",
            main_fields=field_mappings,
            unique_fields=["name"],
            # ... å…¶ä»–é…ç½®
        )
        
        super().__init__(config)
```

### 2. FieldMapping

å­—æ®µæ˜ å°„é…ç½®ç±»ï¼š

```python
FieldMapping(
    field_name="ip_address",      # æ•°æ®åº“å­—æ®µå
    display_name="IPåœ°å€",         # Excel/CSVä¸­æ˜¾ç¤ºçš„åˆ—å
    is_required=True,             # æ˜¯å¦å¿…å¡«
    description="è®¾å¤‡çš„IPåœ°å€",     # å­—æ®µè¯´æ˜
    example="192.168.1.1",        # ç¤ºä¾‹å€¼
    validation_rules=["ip"]       # éªŒè¯è§„åˆ™
)
```

### 3. DeviceImportExportService

è®¾å¤‡å¯¼å…¥å¯¼å‡ºçš„å…·ä½“å®ç°ï¼š

```python
from app.utils.import_export import DeviceImportExportService
from app.utils.deps import OperationContext

# åˆ›å»ºæœåŠ¡å®ä¾‹
service = DeviceImportExportService()

# ç”Ÿæˆå¯¼å…¥æ¨¡æ¿
template_path = await service.export_template(file_format="xlsx")

# å¯¼å…¥æ•°æ®
result = await service.import_data(
    file_path="devices.xlsx",
    operation_context=operation_context,
    update_existing=True
)

# å¯¼å‡ºæ•°æ®
devices = await device_dao.list_all()
export_path = await service.export_data(
    data=devices,
    operation_context=operation_context,
    file_format="xlsx"
)
```

## ä½¿ç”¨æµç¨‹

### 1. å¯¼å‡ºæ¨¡æ¿

```python
# ç”ŸæˆExcelæ¨¡æ¿
template_path = await service.export_template("xlsx")

# ç”ŸæˆCSVæ¨¡æ¿  
template_path = await service.export_template("csv")
```

æ¨¡æ¿åŒ…å«ä¸‰ä¸ªå·¥ä½œè¡¨ï¼š
- **å¯¼å…¥æ•°æ®**: ç”¨äºå¡«å†™å®é™…æ•°æ®
- **ç¤ºä¾‹æ•°æ®**: æä¾›å¡«å†™å‚è€ƒ
- **å­—æ®µè¯´æ˜**: è¯¦ç»†çš„å­—æ®µæè¿°å’Œè¦æ±‚

### 2. æ•°æ®å¯¼å…¥

```python
result = await service.import_data(
    file_path="filled_template.xlsx",
    operation_context=operation_context,
    update_existing=True  # æ˜¯å¦æ›´æ–°å·²å­˜åœ¨çš„è®°å½•
)

# è¿”å›ç»“æœ
{
    "success_count": 10,
    "error_count": 2,
    "errors": ["ç¬¬3è¡Œï¼šIPåœ°å€æ ¼å¼é”™è¯¯"],
    "imported_ids": ["uuid1", "uuid2", ...]
}
```

### 3. æ•°æ®å¯¼å‡º

```python
# æŸ¥è¯¢è¦å¯¼å‡ºçš„æ•°æ®
devices = await device_dao.list_all()

# å¯¼å‡ºä¸ºExcel
export_path = await service.export_data(
    data=devices,
    operation_context=operation_context,
    file_format="xlsx"
)

# å¯¼å‡ºä¸ºCSV
export_path = await service.export_data(
    data=devices,
    operation_context=operation_context, 
    file_format="csv"
)
```

## å­—æ®µéªŒè¯è§„åˆ™

æ”¯æŒçš„éªŒè¯è§„åˆ™ï¼š

- `ip`: IPåœ°å€æ ¼å¼éªŒè¯
- `email`: é‚®ç®±æ ¼å¼éªŒè¯
- `phone`: æ‰‹æœºå·æ ¼å¼éªŒè¯
- `url`: URLæ ¼å¼éªŒè¯
- è‡ªå®šä¹‰æ­£åˆ™è¡¨è¾¾å¼

## å¤–é”®è‡ªåŠ¨åˆ›å»º

DeviceImportExportService æ”¯æŒè‡ªåŠ¨åˆ›å»ºå…³è”æ•°æ®ï¼š

- **å‚å•†æ•°æ®**: å¦‚æœå‚å•†ä¸å­˜åœ¨ï¼Œè‡ªåŠ¨åˆ›å»º
- **åŸºåœ°æ•°æ®**: å¦‚æœåŸºåœ°ä¸å­˜åœ¨ï¼Œè‡ªåŠ¨åˆ›å»º
- **å…¶ä»–å…³è”**: å¯æ‰©å±•æ”¯æŒå…¶ä»–å¤–é”®å…³ç³»

## æ‰©å±•å…¶ä»–æ¨¡å‹

å‚è€ƒ DeviceImportExportService çš„å®ç°æ¨¡å¼ï¼š

```python
class VendorImportExportService(BaseImportExportService):
    def __init__(self):
        field_mappings = [
            FieldMapping("vendor_code", "å‚å•†ç¼–ç ", True, "å”¯ä¸€æ ‡è¯†", "HUAWEI"),
            FieldMapping("vendor_name", "å‚å•†åç§°", True, "å‚å•†å…¨ç§°", "åä¸ºæŠ€æœ¯æœ‰é™å…¬å¸"),
            # ... æ›´å¤šå­—æ®µ
        ]
        
        config = ImportExportConfig(
            model_name="Vendor",
            template_name="å‚å•†å¯¼å…¥æ¨¡æ¿",
            main_fields=field_mappings,
            unique_fields=["vendor_code"],
            update_fields=["vendor_name", "description"]
        )
        
        super().__init__(config)
        self.vendor_dao = VendorDAO()
    
    async def _import_validated_data(self, data, operation_context, update_existing=False):
        # å®ç°å…·ä½“çš„å¯¼å…¥é€»è¾‘
        pass
```

## æ³¨æ„äº‹é¡¹

1. **æƒé™æ§åˆ¶**: ç¡®ä¿ç”¨æˆ·æœ‰ç›¸åº”çš„å¯¼å…¥å¯¼å‡ºæƒé™
2. **æ•°æ®å¤‡ä»½**: å¤§æ‰¹é‡å¯¼å…¥å‰å»ºè®®å¤‡ä»½æ•°æ®
3. **æ€§èƒ½è€ƒè™‘**: å¤§é‡æ•°æ®å»ºè®®åˆ†æ‰¹å¤„ç†
4. **é”™è¯¯å¤„ç†**: ä»”ç»†æ£€æŸ¥éªŒè¯é”™è¯¯ä¿¡æ¯
5. **æ–‡ä»¶ç®¡ç†**: å¯¼å‡ºæ–‡ä»¶ä¼šä¿å­˜åœ¨ä¸´æ—¶ç›®å½•ï¼Œæ³¨æ„æ¸…ç†

## é”™è¯¯å¤„ç†

å¸¸è§é”™è¯¯ç±»å‹ï¼š

- **æ ¼å¼é”™è¯¯**: æ–‡ä»¶æ ¼å¼ä¸æ”¯æŒæˆ–æŸå
- **å­—æ®µç¼ºå¤±**: ç¼ºå°‘å¿…å¡«å­—æ®µ
- **æ•°æ®é‡å¤**: å”¯ä¸€å­—æ®µå†²çª
- **æ ¼å¼éªŒè¯**: IPã€é‚®ç®±ç­‰æ ¼å¼ä¸æ­£ç¡®
- **å¤–é”®é”™è¯¯**: å…³è”æ•°æ®åˆ›å»ºå¤±è´¥

æ¯ä¸ªé”™è¯¯éƒ½ä¼šåŒ…å«å…·ä½“çš„è¡Œå·å’Œé”™è¯¯æè¿°ï¼Œä¾¿äºç”¨æˆ·ä¿®æ­£ã€‚
