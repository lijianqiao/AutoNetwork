# 通用导入导出服务使用说明

## 概述

通用导入导出服务提供了一套完整的数据导入导出解决方案，支持Excel和CSV格式，具备以下特性：

- 🔧 **模板生成**: 自动生成带示例数据和字段说明的导入模板
- 📊 **多格式支持**: 支持 xlsx 和 csv 格式
- 🗺️ **字段映射**: 中英文字段名映射，支持自定义显示名称
- ✅ **数据验证**: 自动验证数据格式、必填字段、唯一性等
- 🔗 **外键处理**: 自动创建关联数据（如厂商、基地等）
- 📝 **操作日志**: 完整的导入导出操作记录

## 核心组件

### 1. BaseImportExportService

抽象基类，提供通用的导入导出功能：

```python
from app.utils.import_export.base import BaseImportExportService, FieldMapping, ImportExportConfig

class MyImportExportService(BaseImportExportService):
    def __init__(self):
        # 配置字段映射
        field_mappings = [
            FieldMapping(
                field_name="name",
                display_name="名称",
                is_required=True,
                description="必填，不能重复"
            ),
            # ... 更多字段
        ]
        
        # 配置导入导出规则
        config = ImportExportConfig(
            model_name="MyModel",
            template_name="我的模板",
            main_fields=field_mappings,
            unique_fields=["name"],
            # ... 其他配置
        )
        
        super().__init__(config)
```

### 2. FieldMapping

字段映射配置类：

```python
FieldMapping(
    field_name="ip_address",      # 数据库字段名
    display_name="IP地址",         # Excel/CSV中显示的列名
    is_required=True,             # 是否必填
    description="设备的IP地址",     # 字段说明
    example="192.168.1.1",        # 示例值
    validation_rules=["ip"]       # 验证规则
)
```

### 3. DeviceImportExportService

设备导入导出的具体实现：

```python
from app.utils.import_export import DeviceImportExportService
from app.utils.deps import OperationContext

# 创建服务实例
service = DeviceImportExportService()

# 生成导入模板
template_path = await service.export_template(file_format="xlsx")

# 导入数据
result = await service.import_data(
    file_path="devices.xlsx",
    operation_context=operation_context,
    update_existing=True
)

# 导出数据
devices = await device_dao.list_all()
export_path = await service.export_data(
    data=devices,
    operation_context=operation_context,
    file_format="xlsx"
)
```

## 使用流程

### 1. 导出模板

```python
# 生成Excel模板
template_path = await service.export_template("xlsx")

# 生成CSV模板  
template_path = await service.export_template("csv")
```

模板包含三个工作表：
- **导入数据**: 用于填写实际数据
- **示例数据**: 提供填写参考
- **字段说明**: 详细的字段描述和要求

### 2. 数据导入

```python
result = await service.import_data(
    file_path="filled_template.xlsx",
    operation_context=operation_context,
    update_existing=True  # 是否更新已存在的记录
)

# 返回结果
{
    "success_count": 10,
    "error_count": 2,
    "errors": ["第3行：IP地址格式错误"],
    "imported_ids": ["uuid1", "uuid2", ...]
}
```

### 3. 数据导出

```python
# 查询要导出的数据
devices = await device_dao.list_all()

# 导出为Excel
export_path = await service.export_data(
    data=devices,
    operation_context=operation_context,
    file_format="xlsx"
)

# 导出为CSV
export_path = await service.export_data(
    data=devices,
    operation_context=operation_context, 
    file_format="csv"
)
```

## 字段验证规则

支持的验证规则：

- `ip`: IP地址格式验证
- `email`: 邮箱格式验证
- `phone`: 手机号格式验证
- `url`: URL格式验证
- 自定义正则表达式

## 外键自动创建

DeviceImportExportService 支持自动创建关联数据：

- **厂商数据**: 如果厂商不存在，自动创建
- **基地数据**: 如果基地不存在，自动创建
- **其他关联**: 可扩展支持其他外键关系

## 扩展其他模型

参考 DeviceImportExportService 的实现模式：

```python
class VendorImportExportService(BaseImportExportService):
    def __init__(self):
        field_mappings = [
            FieldMapping("vendor_code", "厂商编码", True, "唯一标识", "HUAWEI"),
            FieldMapping("vendor_name", "厂商名称", True, "厂商全称", "华为技术有限公司"),
            # ... 更多字段
        ]
        
        config = ImportExportConfig(
            model_name="Vendor",
            template_name="厂商导入模板",
            main_fields=field_mappings,
            unique_fields=["vendor_code"],
            update_fields=["vendor_name", "description"]
        )
        
        super().__init__(config)
        self.vendor_dao = VendorDAO()
    
    async def _import_validated_data(self, data, operation_context, update_existing=False):
        # 实现具体的导入逻辑
        pass
```

## 注意事项

1. **权限控制**: 确保用户有相应的导入导出权限
2. **数据备份**: 大批量导入前建议备份数据
3. **性能考虑**: 大量数据建议分批处理
4. **错误处理**: 仔细检查验证错误信息
5. **文件管理**: 导出文件会保存在临时目录，注意清理

## 错误处理

常见错误类型：

- **格式错误**: 文件格式不支持或损坏
- **字段缺失**: 缺少必填字段
- **数据重复**: 唯一字段冲突
- **格式验证**: IP、邮箱等格式不正确
- **外键错误**: 关联数据创建失败

每个错误都会包含具体的行号和错误描述，便于用户修正。
