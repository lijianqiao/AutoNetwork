# ç½‘ç»œè‡ªåŠ¨åŒ–å¹³å°è®¾è®¡æ–¹æ¡ˆ

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

åŸºäºç°æœ‰FastAPI RBACæ¶æ„ï¼Œæ‰©å±•å¼€å‘ç½‘ç»œè‡ªåŠ¨åŒ–ç®¡ç†å¹³å°ï¼Œæ”¯æŒ1000+å°ç½‘ç»œè®¾å¤‡çš„ç»Ÿä¸€ç®¡ç†ã€æŸ¥è¯¢ã€é…ç½®å’Œç›‘æ§ã€‚

### æ ¸å¿ƒç‰¹æ€§
- **å¤šå“ç‰Œæ”¯æŒ**ï¼šH3C (85%) + åä¸º (10%) + æ€ç§‘ (4%) + å…¶ä»– (1%)
- **åŠ¨æ€è®¤è¯**ï¼šæ”¯æŒåŠ¨æ€å¯†ç  (98%) + é™æ€å¯†ç  (2%)
- **å®æ—¶æŸ¥è¯¢**ï¼šMACåœ°å€æŸ¥è¯¢ã€æ¥å£çŠ¶æ€ã€é…ç½®ä¿¡æ¯ç­‰
- **CLIäº¤äº’**ï¼šWebSocket + Xterm.js å®ç°ç±»CRTä½“éªŒ
- **æƒé™é›†æˆ**ï¼šå®Œå…¨é›†æˆç°æœ‰RBACæƒé™ç®¡ç†ç³»ç»Ÿ

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### æ ¸å¿ƒæŠ€æœ¯æ ˆ

| ç»„ä»¶                  | ç‰ˆæœ¬        | ç”¨é€”                      |
| --------------------- | ----------- | ------------------------- |
| **FastAPI**           | 0.115.12+   | å¼‚æ­¥APIæ¡†æ¶ï¼Œå·²æœ‰RBACåŸºç¡€ |
| **Nornir**            | 3.5.0+      | ç½‘ç»œè‡ªåŠ¨åŒ–ä»»åŠ¡ç¼–æ’        |
| **Scrapli[asyncssh]** | 2025.1.30+  | å¼‚æ­¥SSHè¿æ¥ï¼Œæ”¯æŒåŠ¨æ€å¯†ç  |
| **scrapli-community** | 2025.1.30+  | H3Cç­‰å‚å•†é©±åŠ¨æ”¯æŒ         |
| **TextFSM**           | 1.1.3+      | å‘½ä»¤è¾“å‡ºè§£æ              |
| **ntc-templates**     | 4.1.0+      | é€šç”¨è§£ææ¨¡æ¿åº“            |
| **WebSocket**         | FastAPIå†…ç½® | CLIå®æ—¶äº¤äº’               |
| **Xterm.js**          | 5.3.0+      | å‰ç«¯ç»ˆç«¯æ¨¡æ‹Ÿå™¨            |
| **pandas**            | 2.0.0+      | æ•°æ®å¤„ç†å’Œåˆ†æ            |
| **openpyxl**          | 3.1.0+      | Excelæ–‡ä»¶å¤„ç†             |
| **python-multipart**  | 0.0.6+      | æ–‡ä»¶ä¸Šä¼ å¤„ç†              |

### æ¶æ„åˆ†å±‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     å‰ç«¯å±‚ (Vue3 + Xterm.js)            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     APIå±‚ (FastAPI + RBACæƒé™æ§åˆ¶)      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     ä¸šåŠ¡å±‚ (Service + æ“ä½œæ—¥å¿—)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     ç½‘ç»œå±‚ (Nornir + Scrapli)           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     æ•°æ®å±‚ (PostgreSQL + Redisç¼“å­˜)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“Š æ•°æ®æ¨¡å‹è®¾è®¡

### æ ¸å¿ƒå®ä½“æ‰©å±•

åŸºäºç°æœ‰Userã€Roleã€Permissionã€OperationLogæ¨¡å‹ï¼Œæ–°å¢ç½‘ç»œè®¾å¤‡ç›¸å…³æ¨¡å‹ï¼š

#### 1. Site (åŸºåœ°/ç«™ç‚¹)
```python
class Site(BaseModel):
    site_code: str          # åŸºåœ°ç¼–ç  (cd, wx, sh)
    site_name: str          # åŸºåœ°åç§°
    snmp_community: str     # SNMPç¤¾åŒºå­—ç¬¦ä¸²
    dynamic_password_rules: dict  # åŠ¨æ€å¯†ç è§„åˆ™
    description: str
```

#### 2. Vendor (è®¾å¤‡å“ç‰Œ)
```python
class Vendor(BaseModel):
    vendor_code: str        # å‚å•†ä»£ç  (h3c, huawei, cisco)
    vendor_name: str        # å‚å•†åç§° (åä¸‰, åä¸º, æ€ç§‘)
    scrapli_platform: str   # Scrapliå¹³å°æ ‡è¯† (hp_comware, huawei_vrp, cisco_iosxe)
    default_username: str   # é»˜è®¤ç”¨æˆ·å
    default_port: int       # é»˜è®¤SSHç«¯å£
    connection_timeout: int # è¿æ¥è¶…æ—¶æ—¶é—´(ç§’)
    command_timeout: int    # å‘½ä»¤è¶…æ—¶æ—¶é—´(ç§’)
    supported_device_types: list[str]  # æ”¯æŒçš„è®¾å¤‡ç±»å‹
    description: str
```

#### 3. Device (ç½‘ç»œè®¾å¤‡)
```python
class Device(BaseModel):
    hostname: str           # è®¾å¤‡ä¸»æœºå
    ip_address: str         # ç®¡ç†IPåœ°å€
    device_type: str        # è®¾å¤‡ç±»å‹ (switch, router, firewall)
    vendor_id: UUID         # æ‰€å±å‚å•†ID
    model: str              # è®¾å¤‡å‹å·
    layer: str              # ç½‘ç»œå±‚çº§ (access, aggregation, core)
    site_id: UUID           # æ‰€å±åŸºåœ°
    
    # ç‰©ç†ä¿¡æ¯
    rack_location: str      # æœºæ¶ä½ç½® (å¦‚: A01-U12)
    serial_number: str      # è®¾å¤‡åºåˆ—å·
    purpose: str            # è®¾å¤‡ç”¨é€” (å¦‚: åŠå…¬ç½‘æ¥å…¥, ç”Ÿäº§ç½‘æ±‡èš)
    service_object: str     # æœåŠ¡å¯¹è±¡ (å¦‚: ç ”å‘éƒ¨é—¨, ç”Ÿäº§è½¦é—´)
    
    # è®¤è¯ä¿¡æ¯
    auth_type: str          # è®¤è¯ç±»å‹ (dynamic, static)
    static_username: str    # é™æ€ç”¨æˆ·å (ä»…é™æ€å¯†ç æ—¶ä½¿ç”¨)
    static_password: str    # é™æ€å¯†ç (åŠ å¯†å­˜å‚¨)
    ssh_port: int           # SSHç«¯å£ (é»˜è®¤22)
    
    # çŠ¶æ€ä¿¡æ¯
    is_active: bool         # è®¾å¤‡çŠ¶æ€
    last_connected_at: datetime  # æœ€åè¿æ¥æ—¶é—´
    connection_status: str  # è¿æ¥çŠ¶æ€ (online, offline, unknown)
    
    # æ‰©å±•ä¿¡æ¯
    tags: list[str]         # è®¾å¤‡æ ‡ç­¾
    notes: str              # å¤‡æ³¨ä¿¡æ¯
```

#### 4. QueryTemplate (æŸ¥è¯¢æ¨¡æ¿)
```python
class QueryTemplate(BaseModel):
    template_name: str      # æ¨¡æ¿åç§°
    template_type: str      # æ¨¡æ¿ç±»å‹ (mac_query, interface_status)
    vendor: str             # é€‚ç”¨å‚å•†
    commands: list[str]     # å‘½ä»¤åˆ—è¡¨
    parser_type: str        # è§£æå™¨ç±»å‹ (textfsm, regex)
    parser_template: str    # è§£ææ¨¡æ¿
    description: str
```

#### 5. QueryHistory (æŸ¥è¯¢å†å²)
```python
class QueryHistory(BaseModel):
    user_id: UUID           # æŸ¥è¯¢ç”¨æˆ·
    query_type: str         # æŸ¥è¯¢ç±»å‹
    query_params: dict      # æŸ¥è¯¢å‚æ•°
    target_devices: list[str]  # ç›®æ ‡è®¾å¤‡
    results: dict           # æŸ¥è¯¢ç»“æœ(JSON)
    execution_time: float   # æ‰§è¡Œè€—æ—¶
    status: str             # æ‰§è¡ŒçŠ¶æ€
```

### å…³ç³»è®¾è®¡

```
Site â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚ 1:N
             â–¼
           Device
             â–²
             â”‚ N:1
             â”‚
           Vendor

User â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚ 1:N
             â–¼
       QueryHistory

QueryTemplate â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚ N:M
                      â–¼
                    Device

Vendor â”€â”€â”€â”€â”€â”€â”
             â”‚ 1:N
             â–¼
       QueryTemplate
```

## ğŸ” æƒé™ç³»ç»Ÿæ‰©å±•

### æƒé™æšä¸¾æ‰©å±•

åœ¨ç°æœ‰`Permissions`ç±»ä¸­æ·»åŠ ç½‘ç»œè®¾å¤‡ç›¸å…³æƒé™ï¼š

```python
class Permissions:
    # ç°æœ‰æƒé™...
    
    # åŸºåœ°ç®¡ç†
    SITE_CREATE = "site:create"
    SITE_READ = "site:read"
    SITE_UPDATE = "site:update"
    SITE_DELETE = "site:delete"
    SITE_ACCESS = "site:access"
    
    # å‚å•†ç®¡ç†
    VENDOR_CREATE = "vendor:create"
    VENDOR_READ = "vendor:read"
    VENDOR_UPDATE = "vendor:update"
    VENDOR_DELETE = "vendor:delete"
    VENDOR_ACCESS = "vendor:access"
    
    # è®¾å¤‡ç®¡ç†
    DEVICE_CREATE = "device:create"
    DEVICE_READ = "device:read"
    DEVICE_UPDATE = "device:update"
    DEVICE_DELETE = "device:delete"
    DEVICE_ACCESS = "device:access"
    DEVICE_CONNECT = "device:connect"  # è®¾å¤‡è¿æ¥æƒé™
    DEVICE_IMPORT = "device:import"    # è®¾å¤‡æ‰¹é‡å¯¼å…¥
    DEVICE_EXPORT = "device:export"    # è®¾å¤‡ä¿¡æ¯å¯¼å‡º
    
    # æŸ¥è¯¢åŠŸèƒ½
    QUERY_MAC = "query:mac"            # MACåœ°å€æŸ¥è¯¢
    QUERY_INTERFACE = "query:interface"  # æ¥å£æŸ¥è¯¢
    QUERY_CONFIG = "query:config"      # é…ç½®æŸ¥è¯¢
    QUERY_BATCH = "query:batch"        # æ‰¹é‡æŸ¥è¯¢
    QUERY_EXPORT = "query:export"      # ç»“æœå¯¼å‡º
    
    # æŸ¥è¯¢æ¨¡æ¿
    TEMPLATE_CREATE = "template:create"
    TEMPLATE_READ = "template:read"
    TEMPLATE_UPDATE = "template:update"
    TEMPLATE_DELETE = "template:delete"
    TEMPLATE_ACCESS = "template:access"
    
    # CLIåŠŸèƒ½
    CLI_ACCESS = "cli:access"          # CLIè®¿é—®æƒé™
    CLI_EXECUTE = "cli:execute"        # å‘½ä»¤æ‰§è¡Œæƒé™
    CLI_CONFIG = "cli:config"          # é…ç½®å‘½ä»¤æƒé™
    
    # é…ç½®ç®¡ç†
    CONFIG_BACKUP = "config:backup"    # é…ç½®å¤‡ä»½
    CONFIG_RESTORE = "config:restore"  # é…ç½®æ¢å¤
    CONFIG_COMPARE = "config:compare"  # é…ç½®å¯¹æ¯”
```

### æƒé™åˆ†çº§ç­–ç•¥

| è§’è‰²           | æƒé™èŒƒå›´      | å…¸å‹æƒé™                    |
| -------------- | ------------- | --------------------------- |
| **ç½‘ç»œç®¡ç†å‘˜** | å…¨éƒ¨æƒé™      | æ‰€æœ‰è®¾å¤‡æ“ä½œã€é…ç½®ç®¡ç†      |
| **è¿ç»´å·¥ç¨‹å¸ˆ** | æŸ¥è¯¢+åŸºç¡€æ“ä½œ | è®¾å¤‡æŸ¥è¯¢ã€çŠ¶æ€ç›‘æ§ã€åŸºç¡€CLI |
| **å€¼ç­äººå‘˜**   | åªè¯»æŸ¥è¯¢      | MACæŸ¥è¯¢ã€æ¥å£çŠ¶æ€æŸ¥çœ‹       |
| **å®¡è®¡äººå‘˜**   | æ—¥å¿—æŸ¥çœ‹      | æ“ä½œæ—¥å¿—ã€æŸ¥è¯¢å†å²          |

## ğŸš€ æ ¸å¿ƒåŠŸèƒ½å®ç°

### 1. è®¾å¤‡è¿æ¥ç®¡ç†

#### åŠ¨æ€å¯†ç è®¤è¯
```python
class DynamicPasswordManager:
    """åŠ¨æ€å¯†ç ç®¡ç†å™¨"""
    
    def generate_username(self, site_code: str, layer: str) -> str:
        """æ ¹æ®åŸºåœ°å’Œå±‚çº§ç”ŸæˆåŠ¨æ€ç”¨æˆ·å"""
        base_map = {
            "cd": "opcd",  # æˆéƒ½
            "wx": "opwx",  # æ— é”¡
            "sh": "opsh",  # ä¸Šæµ·
        }
        layer_map = {
            "access": "jr",      # æ¥å…¥å±‚
            "aggregation": "hj", # æ±‡èšå±‚
            "core": "hx"         # æ ¸å¿ƒå±‚
        }
        return f"{base_map[site_code]}{layer_map[layer]}"
    
    def get_auth_credentials(self, device: Device) -> tuple[str, str]:
        """è·å–è®¾å¤‡è®¤è¯å‡­æ®"""
        if device.auth_type == "static":
            return device.static_username, decrypt_password(device.static_password)
        else:
            # åŠ¨æ€å¯†ç è®¤è¯
            username = self.generate_username(device.site.site_code, device.layer)
            password = self._get_dynamic_password()  # ä»å¤–éƒ¨ç³»ç»Ÿè·å–å½“å‰åŠ¨æ€å¯†ç 
            return username, password
```

#### è®¾å¤‡è¿æ¥æ± 
```python
class DeviceConnectionManager:
    """è®¾å¤‡è¿æ¥ç®¡ç†å™¨"""
    
    async def get_connection(self, device: Device, manual_password: str = None):
        """è·å–è®¾å¤‡è¿æ¥"""
        # è·å–è®¤è¯å‡­æ®
        if manual_password:
            # æ‰‹åŠ¨è¾“å…¥å¯†ç ï¼ˆç”¨äºåŠ¨æ€å¯†ç ï¼‰
            username = self.dynamic_password_manager.generate_username(
                device.site.site_code, device.layer
            )
            password = manual_password
        else:
            username, password = self.dynamic_password_manager.get_auth_credentials(device)
            
        # è·å–å‚å•†é…ç½®
        vendor = await self.vendor_dao.get_by_id(device.vendor_id)
        
        return await self.scrapli_manager.get_connection(
            host=device.ip_address,
            auth_username=username,
            auth_password=password,
            platform=vendor.scrapli_platform,
            port=device.ssh_port or vendor.default_port,
            timeout_socket=vendor.connection_timeout,
            timeout_ops=vendor.command_timeout
        )
```

### 2. é€šç”¨æŸ¥è¯¢å¼•æ“

#### æŸ¥è¯¢å¼•æ“æ¶æ„
```python
class QueryEngine:
    """é€šç”¨æŸ¥è¯¢å¼•æ“"""
    
    async def execute_query(
        self, 
        template: QueryTemplate, 
        devices: list[Device],
        params: dict
    ) -> dict:
        """æ‰§è¡ŒæŸ¥è¯¢"""
        results = {}
        
        # ä½¿ç”¨Nornirå¹¶è¡Œæ‰§è¡Œ
        async with self.nornir_manager.get_runner() as nr:
            for device in devices:
                task_result = await nr.run(
                    task=self._execute_device_query,
                    device=device,
                    template=template,
                    params=params
                )
                results[device.hostname] = task_result
                
        return results
    
    async def _execute_device_query(self, device, template, params):
        """å•è®¾å¤‡æŸ¥è¯¢æ‰§è¡Œ"""
        conn = await self.connection_manager.get_connection(device)
        
        raw_results = []
        for command in template.commands:
            # å‚æ•°åŒ–å‘½ä»¤
            formatted_command = command.format(**params)
            result = await conn.send_command(formatted_command)
            raw_results.append(result.result)
            
        # ä½¿ç”¨TextFSMè§£æ
        parsed_results = self.parser.parse(
            template.parser_template, 
            "\n".join(raw_results)
        )
        
        return parsed_results
```

#### MACåœ°å€æŸ¥è¯¢å®ç°
```python
class MacQueryService(BaseService):
    """MACåœ°å€æŸ¥è¯¢æœåŠ¡"""
    
    @log_query_with_context("mac_query")
    async def query_mac_address(
        self, 
        mac_address: str, 
        operation_context: OperationContext
    ) -> dict:
        """MACåœ°å€æŸ¥è¯¢"""
        # æ ‡å‡†åŒ–MACåœ°å€æ ¼å¼
        normalized_mac = self._normalize_mac(mac_address)
        
        # æ£€æŸ¥ç¼“å­˜
        cache_key = f"mac_query:{normalized_mac}"
        cached_result = await self.redis_cache.get(cache_key)
        if cached_result:
            return cached_result
            
        # è·å–æ‰€æœ‰äº¤æ¢æœºè®¾å¤‡
        switches = await self.device_dao.get_all(
            device_type="switch", 
            is_active=True
        )
        
        # è·å–MACæŸ¥è¯¢æ¨¡æ¿
        template = await self.template_dao.get_one(
            template_type="mac_query"
        )
        
        # æ‰§è¡ŒæŸ¥è¯¢
        results = await self.query_engine.execute_query(
            template=template,
            devices=switches,
            params={"mac_address": normalized_mac}
        )
        
        # è§£æç»“æœï¼Œæ‰¾åˆ°MACåœ°å€æ‰€åœ¨ä½ç½®
        location = self._parse_mac_location(results)
        
        # ç¼“å­˜ç»“æœï¼ˆ5åˆ†é’Ÿï¼‰
        await self.redis_cache.set(cache_key, location, 300)
        
        return location
```

### 3. CLIäº¤äº’åŠŸèƒ½

#### WebSocket CLIå¤„ç†å™¨
```python
class CLIWebSocketHandler:
    """CLI WebSocketå¤„ç†å™¨"""
    
    async def handle_connection(self, websocket: WebSocket, device_id: str):
        """å¤„ç†CLIè¿æ¥"""
        await websocket.accept()
        
        # æƒé™éªŒè¯
        user = await self.auth_service.get_current_user(websocket)
        if not await self.permission_manager.check_permission(
            user, Permissions.CLI_ACCESS
        ):
            await websocket.close(code=4003, reason="æƒé™ä¸è¶³")
            return
            
        # è·å–è®¾å¤‡è¿æ¥
        device = await self.device_dao.get_by_id(device_id)
        device_conn = await self.connection_manager.get_connection(device)
        
        try:
            # å»ºç«‹CLIä¼šè¯
            async with device_conn.channel() as channel:
                # å¯åŠ¨åŒå‘æ•°æ®è½¬å‘
                await asyncio.gather(
                    self._forward_to_device(websocket, channel),
                    self._forward_to_client(channel, websocket)
                )
        except Exception as e:
            await websocket.close(code=4000, reason=str(e))
    
    async def _forward_to_device(self, websocket, channel):
        """è½¬å‘å®¢æˆ·ç«¯è¾“å…¥åˆ°è®¾å¤‡"""
        async for message in websocket.iter_text():
            # å‘½ä»¤æƒé™æ£€æŸ¥
            if self._is_config_command(message):
                if not await self.permission_manager.check_permission(
                    self.current_user, Permissions.CLI_CONFIG
                ):
                    await websocket.send_text("é”™è¯¯: é…ç½®å‘½ä»¤æƒé™ä¸è¶³\n")
                    continue
                    
            # è®°å½•å‘½ä»¤æ—¥å¿—
            await self._log_cli_command(message)
            
            # å‘é€åˆ°è®¾å¤‡
            await channel.send_input(message)
    
    async def _forward_to_client(self, channel, websocket):
        """è½¬å‘è®¾å¤‡è¾“å‡ºåˆ°å®¢æˆ·ç«¯"""
        async for output in channel.iter_output():
            await websocket.send_text(output)
```

### 4. æŸ¥è¯¢æ¨¡æ¿ç®¡ç†

#### æ¨¡æ¿å®šä¹‰ç¤ºä¾‹
```python
# H3C MACæŸ¥è¯¢æ¨¡æ¿
H3C_MAC_TEMPLATE = {
    "template_name": "H3C MACåœ°å€æŸ¥è¯¢",
    "vendor": "h3c",
    "commands": [
        "display mac-address {mac_address}",
        "display interface brief"
    ],
    "parser_template": """
Value VLAN (\d+)
Value MAC ([a-fA-F0-9-]+)
Value TYPE (\w+)
Value INTERFACE (\S+)
Value AGING (\d+)

Start
  ^\s*${VLAN}\s+${MAC}\s+${TYPE}\s+${INTERFACE}\s+${AGING} -> Record
"""
}

# åä¸ºMACæŸ¥è¯¢æ¨¡æ¿
HUAWEI_MAC_TEMPLATE = {
    "template_name": "åä¸º MACåœ°å€æŸ¥è¯¢",
    "vendor": "huawei",
    "commands": [
        "display mac-address {mac_address}"
    ],
    "parser_template": """
Value VLAN (\d+)
Value MAC ([a-fA-F0-9-]+)
Value TYPE (\w+)
Value INTERFACE (\S+)

Start
  ^\s*${VLAN}\s+${MAC}\s+${TYPE}\s+${INTERFACE} -> Record
"""
}
```

## ğŸ“¡ APIæ¥å£è®¾è®¡

### åŸºåœ°ç®¡ç† (`/api/v1/sites`)
```python
@router.get("", response_model=SiteListResponse)
async def list_sites(
    query: SiteListRequest = Depends(),
    operation_context: OperationContext = Depends(require_permission(Permissions.SITE_READ))
):
    """è·å–åŸºåœ°åˆ—è¡¨"""

@router.post("", response_model=SiteResponse)
async def create_site(
    site_data: SiteCreateRequest,
    operation_context: OperationContext = Depends(require_permission(Permissions.SITE_CREATE))
):
    """åˆ›å»ºåŸºåœ°"""
```

### å‚å•†ç®¡ç† (`/api/v1/vendors`)
```python
@router.get("", response_model=VendorListResponse)
async def list_vendors(
    query: VendorListRequest = Depends(),
    operation_context: OperationContext = Depends(require_permission(Permissions.VENDOR_READ))
):
    """è·å–å‚å•†åˆ—è¡¨"""

@router.post("", response_model=VendorResponse)
async def create_vendor(
    vendor_data: VendorCreateRequest,
    operation_context: OperationContext = Depends(require_permission(Permissions.VENDOR_CREATE))
):
    """åˆ›å»ºå‚å•†"""

@router.get("/{vendor_id}/device-types", response_model=DeviceTypeListResponse)
async def get_vendor_device_types(
    vendor_id: UUID,
    operation_context: OperationContext = Depends(require_permission(Permissions.VENDOR_READ))
):
    """è·å–å‚å•†æ”¯æŒçš„è®¾å¤‡ç±»å‹"""
```

### è®¾å¤‡ç®¡ç† (`/api/v1/devices`)
```python
@router.get("", response_model=DeviceListResponse)
async def list_devices(
    query: DeviceListRequest = Depends(),
    operation_context: OperationContext = Depends(require_permission(Permissions.DEVICE_READ))
):
    """è·å–è®¾å¤‡åˆ—è¡¨"""

@router.post("", response_model=DeviceResponse)
async def create_device(
    device_data: DeviceCreateRequest,
    operation_context: OperationContext = Depends(require_permission(Permissions.DEVICE_CREATE))
):
    """åˆ›å»ºè®¾å¤‡"""

@router.post("/{device_id}/connect", response_model=ConnectionResponse)
async def test_device_connection(
    device_id: UUID,
    connection_data: DeviceConnectionRequest,
    operation_context: OperationContext = Depends(require_permission(Permissions.DEVICE_CONNECT))
):
    """æµ‹è¯•è®¾å¤‡è¿æ¥ï¼ˆæ”¯æŒæ‰‹åŠ¨å¯†ç è¾“å…¥ï¼‰"""

@router.post("/import", response_model=DeviceImportResponse)
async def import_devices(
    file: UploadFile,
    operation_context: OperationContext = Depends(require_permission(Permissions.DEVICE_IMPORT))
):
    """æ‰¹é‡å¯¼å…¥è®¾å¤‡ï¼ˆExcel/CSVï¼‰"""

@router.get("/export", response_class=FileResponse)
async def export_devices(
    query: DeviceExportRequest = Depends(),
    operation_context: OperationContext = Depends(require_permission(Permissions.DEVICE_EXPORT))
):
    """å¯¼å‡ºè®¾å¤‡ä¿¡æ¯"""

@router.get("/{device_id}/credentials", response_model=DeviceCredentialsResponse)
async def get_device_credentials(
    device_id: UUID,
    operation_context: OperationContext = Depends(require_permission(Permissions.DEVICE_CONNECT))
):
    """è·å–è®¾å¤‡è®¤è¯ä¿¡æ¯ï¼ˆåŠ¨æ€ç”¨æˆ·åç”Ÿæˆï¼‰"""
```

### æŸ¥è¯¢åŠŸèƒ½ (`/api/v1/queries`)
```python
@router.post("/mac", response_model=MacQueryResponse)
async def query_mac_address(
    query_data: MacQueryRequest,
    operation_context: OperationContext = Depends(require_permission(Permissions.QUERY_MAC))
):
    """MACåœ°å€æŸ¥è¯¢"""

@router.post("/batch", response_model=BatchQueryResponse)
async def execute_batch_query(
    query_data: BatchQueryRequest,
    operation_context: OperationContext = Depends(require_permission(Permissions.QUERY_BATCH))
):
    """æ‰¹é‡æŸ¥è¯¢"""
```

### CLIåŠŸèƒ½ (`/api/v1/cli`)
```python
@router.websocket("/devices/{device_id}")
async def cli_websocket(
    websocket: WebSocket,
    device_id: UUID,
    # æƒé™éªŒè¯åœ¨WebSocketå¤„ç†å™¨ä¸­è¿›è¡Œ
):
    """è®¾å¤‡CLI WebSocketè¿æ¥"""
```

## ğŸ”„ å¼€å‘å®æ–½è®¡åˆ’

### ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€æ¨¡å‹å’Œæƒé™æ‰©å±• (1-2å‘¨)
1. **æƒé™æšä¸¾æ‰©å±•**ï¼šåœ¨`Permissions`ç±»ä¸­æ·»åŠ ç½‘ç»œè®¾å¤‡ç›¸å…³æƒé™
2. **æ•°æ®æ¨¡å‹åˆ›å»º**ï¼šVendorã€Siteã€Deviceã€QueryTemplateã€QueryHistoryæ¨¡å‹
3. **æ•°æ®åº“è¿ç§»**ï¼šä½¿ç”¨aerichåˆ›å»ºè¿ç§»æ–‡ä»¶
4. **åŸºç¡€DAOå±‚**ï¼šç»§æ‰¿BaseDAOï¼Œå®ç°åŸºç¡€CRUDæ“ä½œ
5. **è®¾å¤‡å¯¼å…¥å¯¼å‡º**ï¼šå®ç°Excel/CSVæ ¼å¼çš„è®¾å¤‡æ‰¹é‡å¯¼å…¥å¯¼å‡ºåŠŸèƒ½

### ç¬¬äºŒé˜¶æ®µï¼šè®¾å¤‡è¿æ¥å’Œè®¤è¯ (2-3å‘¨)
1. **åŠ¨æ€å¯†ç ç®¡ç†å™¨**ï¼šå®ç°æ‰‹åŠ¨è¾“å…¥å¯†ç 
2. **è®¾å¤‡è¿æ¥ç®¡ç†**ï¼šé›†æˆScrapliï¼Œæ”¯æŒå¤šå‚å•†è¿æ¥
3. **è¿æ¥æ± ç®¡ç†**ï¼šä¼˜åŒ–è¿æ¥å¤ç”¨å’Œè¶…æ—¶å¤„ç†
4. **è®¤è¯æµ‹è¯•**ï¼šéªŒè¯å„å‚å•†è®¾å¤‡è¿æ¥ç¨³å®šæ€§

### ç¬¬ä¸‰é˜¶æ®µï¼šæŸ¥è¯¢å¼•æ“å¼€å‘ (2-3å‘¨)
1. **Norniré›†æˆ**ï¼šå®ç°å¹¶è¡Œä»»åŠ¡æ‰§è¡Œæ¡†æ¶
2. **TextFSMè§£æå™¨**ï¼šé›†æˆntc-templatesè§£æåº“
3. **æŸ¥è¯¢æ¨¡æ¿ç®¡ç†**ï¼šå®ç°æ¨¡æ¿CRUDå’Œç‰ˆæœ¬ç®¡ç†
4. **MACæŸ¥è¯¢åŠŸèƒ½**ï¼šå®ç°æ ¸å¿ƒMACåœ°å€æŸ¥è¯¢åŠŸèƒ½

### ç¬¬å››é˜¶æ®µï¼šCLIäº¤äº’åŠŸèƒ½ (2-3å‘¨)
1. **WebSocketå¤„ç†å™¨**ï¼šå®ç°CLIè¿æ¥å’Œæƒé™éªŒè¯
2. **å‘½ä»¤è¿‡æ»¤å™¨**ï¼šå®ç°å±é™©å‘½ä»¤æ‹¦æˆªå’Œæƒé™æ§åˆ¶
3. **ä¼šè¯ç®¡ç†**ï¼šå®ç°å¤šç”¨æˆ·å¹¶å‘CLIä¼šè¯
4. **å‰ç«¯é›†æˆ**ï¼šé›†æˆXterm.jså®ç°ç»ˆç«¯ç•Œé¢

### ç¬¬äº”é˜¶æ®µï¼šé«˜çº§åŠŸèƒ½å’Œä¼˜åŒ– (2-3å‘¨)
1. **æ‰¹é‡æŸ¥è¯¢**ï¼šå®ç°å¤šè®¾å¤‡å¹¶è¡ŒæŸ¥è¯¢
2. **ç»“æœå¯¼å‡º**ï¼šæ”¯æŒExcelã€CSVæ ¼å¼å¯¼å‡º
3. **æŸ¥è¯¢å†å²**ï¼šå®ç°æŸ¥è¯¢è®°å½•å’Œç»“æœå›æ”¾
4. **æ€§èƒ½ä¼˜åŒ–**ï¼šRedisç¼“å­˜ã€è¿æ¥æ± ä¼˜åŒ–

### ç¬¬å…­é˜¶æ®µï¼šæµ‹è¯•å’Œéƒ¨ç½² (1-2å‘¨)
1. **å•å…ƒæµ‹è¯•**ï¼šæ ¸å¿ƒåŠŸèƒ½æµ‹è¯•è¦†ç›–
2. **é›†æˆæµ‹è¯•**ï¼šç«¯åˆ°ç«¯åŠŸèƒ½éªŒè¯
3. **æ€§èƒ½æµ‹è¯•**ï¼šå¹¶å‘è¿æ¥å’ŒæŸ¥è¯¢å‹åŠ›æµ‹è¯•
4. **ç”Ÿäº§éƒ¨ç½²**ï¼šDockerå®¹å™¨åŒ–å’Œç›‘æ§é…ç½®

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### è¿æ¥ä¼˜åŒ–
- **è¿æ¥æ± ç®¡ç†**ï¼šå¤ç”¨è®¾å¤‡è¿æ¥ï¼Œå‡å°‘å»ºè¿å¼€é”€
- **å¹¶å‘æ§åˆ¶**ï¼šé™åˆ¶å•è®¾å¤‡å¹¶å‘è¿æ¥æ•°ï¼Œé¿å…è®¾å¤‡è¿‡è½½
- **è¶…æ—¶å¤„ç†**ï¼šåˆç†è®¾ç½®è¿æ¥å’Œå‘½ä»¤è¶…æ—¶æ—¶é—´

### æŸ¥è¯¢ä¼˜åŒ–
- **ç»“æœç¼“å­˜**ï¼šRedisç¼“å­˜å¸¸ç”¨æŸ¥è¯¢ç»“æœï¼ŒTTL 5-10åˆ†é’Ÿ
- **å¹¶è¡Œæ‰§è¡Œ**ï¼šNornirå¹¶è¡ŒæŸ¥è¯¢å¤šè®¾å¤‡ï¼Œæå‡æ•ˆç‡
- **æ™ºèƒ½è·¯ç”±**ï¼šæ ¹æ®æŸ¥è¯¢ç±»å‹é€‰æ‹©æœ€ä¼˜è®¾å¤‡å­é›†

### ç¼“å­˜ç­–ç•¥
- **æŸ¥è¯¢ç»“æœç¼“å­˜**ï¼šMACæŸ¥è¯¢ã€æ¥å£çŠ¶æ€ç­‰ç¼“å­˜5-10åˆ†é’Ÿ
- **è®¾å¤‡ä¿¡æ¯ç¼“å­˜**ï¼šè®¾å¤‡åˆ—è¡¨ã€æ¨¡æ¿ä¿¡æ¯ç¼“å­˜1å°æ—¶
- **æƒé™ç¼“å­˜**ï¼šå¤ç”¨ç°æœ‰PermissionCacheæœºåˆ¶

## ğŸ”’ å®‰å…¨è€ƒè™‘

### è®¤è¯å®‰å…¨
- **å¯†ç åŠ å¯†**ï¼šé™æ€å¯†ç ä½¿ç”¨AESåŠ å¯†å­˜å‚¨
- **åŠ¨æ€å¯†ç **ï¼šæ”¯æŒç”¨æˆ·æ‰‹åŠ¨è¾“å…¥ï¼Œä¸æŒä¹…åŒ–å­˜å‚¨
- **è¿æ¥å®¡è®¡**ï¼šè®°å½•æ‰€æœ‰è®¾å¤‡è¿æ¥å’Œå‘½ä»¤æ‰§è¡Œ

### æƒé™æ§åˆ¶
- **åˆ†çº§æƒé™**ï¼šæŸ¥è¯¢ã€è¿æ¥ã€é…ç½®ä¸‰çº§æƒé™æ§åˆ¶
- **å‘½ä»¤è¿‡æ»¤**ï¼šå±é™©å‘½ä»¤æ‹¦æˆªå’Œç™½åå•æœºåˆ¶
- **æ“ä½œå®¡è®¡**ï¼šå®Œæ•´çš„æ“ä½œæ—¥å¿—å’Œæƒé™éªŒè¯è®°å½•

### ç½‘ç»œå®‰å…¨
- **SSHå¯†é’¥**ï¼šæ”¯æŒå¯†é’¥è®¤è¯æ–¹å¼
- **ç½‘ç»œéš”ç¦»**ï¼šç®¡ç†ç½‘ç»œå’Œä¸šåŠ¡ç½‘ç»œåˆ†ç¦»
- **è®¿é—®æ§åˆ¶**ï¼šåŸºäºIPå’Œæ—¶é—´çš„è®¿é—®é™åˆ¶

## ğŸ“Š ç›‘æ§å’Œè¿ç»´

### ç³»ç»Ÿç›‘æ§
- **è¿æ¥çŠ¶æ€**ï¼šå®æ—¶ç›‘æ§è®¾å¤‡è¿æ¥çŠ¶æ€
- **æŸ¥è¯¢æ€§èƒ½**ï¼šç»Ÿè®¡æŸ¥è¯¢å“åº”æ—¶é—´å’ŒæˆåŠŸç‡
- **èµ„æºä½¿ç”¨**ï¼šç›‘æ§CPUã€å†…å­˜ã€ç½‘ç»œä½¿ç”¨æƒ…å†µ

### ä¸šåŠ¡ç›‘æ§
- **è®¾å¤‡å¥åº·åº¦**ï¼šåŸºäºè¿æ¥æˆåŠŸç‡è¯„ä¼°è®¾å¤‡çŠ¶æ€
- **ç”¨æˆ·æ´»è·ƒåº¦**ï¼šç»Ÿè®¡ç”¨æˆ·æŸ¥è¯¢é¢‘æ¬¡å’Œä½¿ç”¨æ¨¡å¼
- **é”™è¯¯åˆ†æ**ï¼šåˆ†æè¿æ¥å¤±è´¥å’ŒæŸ¥è¯¢å¼‚å¸¸åŸå› 

### å‘Šè­¦æœºåˆ¶
- **è®¾å¤‡ç¦»çº¿å‘Šè­¦**ï¼šè®¾å¤‡è¿æ¥å¤±è´¥è¶…è¿‡é˜ˆå€¼æ—¶å‘Šè­¦
- **æ€§èƒ½å‘Šè­¦**ï¼šæŸ¥è¯¢å“åº”æ—¶é—´è¶…è¿‡é˜ˆå€¼æ—¶å‘Šè­¦
- **å®‰å…¨å‘Šè­¦**ï¼šå¼‚å¸¸ç™»å½•å’Œå±é™©æ“ä½œå‘Šè­¦

## ğŸ¯ æ€»ç»“

æœ¬è®¾è®¡æ–¹æ¡ˆåŸºäºç°æœ‰FastAPI RBACæ¶æ„ï¼Œé€šè¿‡æœ€å°åŒ–æ‰©å±•å®ç°ç½‘ç»œè‡ªåŠ¨åŒ–å¹³å°çš„æ ¸å¿ƒåŠŸèƒ½ï¼š

### æ ¸å¿ƒä¼˜åŠ¿
1. **æ¶æ„ä¸€è‡´æ€§**ï¼šå®Œå…¨éµå¾ªç°æœ‰RBACæ¨¡å¼ï¼Œæ— ç¼é›†æˆ
2. **æŠ€æœ¯å…ˆè¿›æ€§**ï¼šå¼‚æ­¥æ¶æ„ + ç°ä»£åŒ–ç½‘ç»œè‡ªåŠ¨åŒ–å·¥å…·é“¾
3. **æ‰©å±•æ€§å¼º**ï¼šæ¨¡å—åŒ–è®¾è®¡ï¼Œæ”¯æŒæ–°å‚å•†å’ŒåŠŸèƒ½æ‰©å±•
4. **å®‰å…¨å¯é **ï¼šå¤šå±‚æƒé™æ§åˆ¶ + å®Œæ•´æ“ä½œå®¡è®¡
5. **æ€§èƒ½ä¼˜å¼‚**ï¼šå¹¶è¡ŒæŸ¥è¯¢ + å¤šçº§ç¼“å­˜ + è¿æ¥æ± ä¼˜åŒ–
6. **ç®¡ç†ä¾¿æ·**ï¼šå‚å•†ä¿¡æ¯é›†ä¸­ç®¡ç† + è®¾å¤‡æ‰¹é‡å¯¼å…¥å¯¼å‡ºåŠŸèƒ½

### å®æ–½å»ºè®®
1. **åˆ†é˜¶æ®µå¼€å‘**ï¼šæŒ‰ç…§6ä¸ªé˜¶æ®µé€æ­¥å®æ–½ï¼Œé™ä½é£é™©
2. **æƒé™ä¼˜å…ˆ**ï¼šé¦–å…ˆå®Œæˆæƒé™æ‰©å±•ï¼Œç¡®ä¿å®‰å…¨åŸºç¡€
3. **æ ¸å¿ƒåŠŸèƒ½å…ˆè¡Œ**ï¼šä¼˜å…ˆå®ç°MACæŸ¥è¯¢ç­‰æ ¸å¿ƒä¸šåŠ¡åŠŸèƒ½
4. **å……åˆ†æµ‹è¯•**ï¼šé‡ç‚¹æµ‹è¯•å¤šå‚å•†å…¼å®¹æ€§å’Œå¹¶å‘æ€§èƒ½
5. **æ¸è¿›éƒ¨ç½²**ï¼šå…ˆå°èŒƒå›´è¯•ç‚¹ï¼Œå†å…¨é¢æ¨å¹¿

é€šè¿‡æœ¬æ–¹æ¡ˆçš„å®æ–½ï¼Œå°†æ„å»ºä¸€ä¸ªåŠŸèƒ½å®Œå–„ã€æ€§èƒ½ä¼˜å¼‚ã€å®‰å…¨å¯é çš„ç½‘ç»œè‡ªåŠ¨åŒ–ç®¡ç†å¹³å°ï¼Œæœ‰æ•ˆæå‡ç½‘ç»œè¿ç»´æ•ˆç‡å’Œç®¡ç†æ°´å¹³ã€‚