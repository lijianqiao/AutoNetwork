# æŸ¥è¯¢æ¨¡æ¿ç®¡ç†åŠŸèƒ½æ–‡æ¡£

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

æŸ¥è¯¢æ¨¡æ¿ç®¡ç†æ˜¯ç½‘ç»œè‡ªåŠ¨åŒ–å¹³å°çš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€ï¼Œæ—¨åœ¨è§£å†³å¤šå‚å•†ç½‘ç»œè®¾å¤‡å‘½ä»¤å·®å¼‚é—®é¢˜ï¼Œæä¾›ç»Ÿä¸€çš„æŸ¥è¯¢æ¥å£å’Œæ¨¡æ¿åŒ–çš„å‘½ä»¤ç®¡ç†æœºåˆ¶ã€‚

### ğŸ¯ æ ¸å¿ƒç‰¹æ€§

- **å¤šå‚å•†å‘½ä»¤é€‚é…**ï¼šæ”¯æŒH3Cã€åä¸ºã€æ€ç§‘ç­‰ä¸»æµå‚å•†çš„å‘½ä»¤å·®å¼‚
- **æ¨¡æ¿åŒ–å‚æ•°æ”¯æŒ**ï¼šåŠ¨æ€å‚æ•°æ›¿æ¢ï¼Œæ”¯æŒå¤æ‚æŸ¥è¯¢åœºæ™¯
- **æ´»æ€§æ§åˆ¶åŠŸèƒ½**ï¼šçµæ´»çš„æ¨¡æ¿å¯ç”¨/ç¦ç”¨ç®¡ç†
- **ç‰ˆæœ¬ç®¡ç†æœºåˆ¶**ï¼šæ”¯æŒæ¨¡æ¿çš„ç‰ˆæœ¬æ§åˆ¶å’Œå†å²è¿½è¸ª
- **æƒé™æ§åˆ¶ä½“ç³»**ï¼šåŸºäºRBACçš„ç»†ç²’åº¦æƒé™ç®¡ç†
- **æ‰¹é‡æ“ä½œæ”¯æŒ**ï¼šé«˜æ•ˆçš„æ‰¹é‡åˆ›å»ºã€æ›´æ–°ã€æ¿€æ´»æ“ä½œ

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ•°æ®æ¨¡å‹å…³ç³»

```
QueryTemplate (æŸ¥è¯¢æ¨¡æ¿)
â”œâ”€â”€ id: ä¸»é”®
â”œâ”€â”€ template_name: æ¨¡æ¿åç§°
â”œâ”€â”€ template_type: æ¨¡æ¿ç±»å‹
â”œâ”€â”€ description: æè¿°ä¿¡æ¯
â”œâ”€â”€ is_active: æ¿€æ´»çŠ¶æ€
â”œâ”€â”€ created_at: åˆ›å»ºæ—¶é—´
â”œâ”€â”€ updated_at: æ›´æ–°æ—¶é—´
â””â”€â”€ vendor_commands: å…³è”çš„å‚å•†å‘½ä»¤åˆ—è¡¨

VendorCommand (å‚å•†å‘½ä»¤)
â”œâ”€â”€ id: ä¸»é”®
â”œâ”€â”€ template_id: å…³è”æ¨¡æ¿ID
â”œâ”€â”€ vendor_id: å‚å•†ID
â”œâ”€â”€ command_template: å‘½ä»¤æ¨¡æ¿
â”œâ”€â”€ description: å‘½ä»¤æè¿°
â”œâ”€â”€ parameters: å‚æ•°å®šä¹‰(JSON)
â”œâ”€â”€ expected_output_format: æœŸæœ›è¾“å‡ºæ ¼å¼
â”œâ”€â”€ created_at: åˆ›å»ºæ—¶é—´
â””â”€â”€ updated_at: æ›´æ–°æ—¶é—´
```

### åˆ†å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   API Layer    â”‚  â† æƒé™æ§åˆ¶ã€å‚æ•°éªŒè¯ã€å“åº”æ ¼å¼åŒ–
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Service Layer   â”‚  â† ä¸šåŠ¡é€»è¾‘ã€æ“ä½œæ—¥å¿—ã€äº‹åŠ¡ç®¡ç†
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   DAO Layer     â”‚  â† æ•°æ®è®¿é—®ã€æŸ¥è¯¢ä¼˜åŒ–ã€å…³è”æŸ¥è¯¢
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Model Layer    â”‚  â† æ•°æ®æ¨¡å‹ã€å…³ç³»å®šä¹‰ã€çº¦æŸè§„åˆ™
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ æ–‡ä»¶ç»“æ„

```
app/
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ query_template.py      # æŸ¥è¯¢æ¨¡æ¿æ•°æ®æ¨¡å‹
â”‚   â””â”€â”€ vendor_command.py      # å‚å•†å‘½ä»¤æ•°æ®æ¨¡å‹
â”œâ”€â”€ schemas/
â”‚   â”œâ”€â”€ query_template.py      # æŸ¥è¯¢æ¨¡æ¿æ•°æ®æ ¡éªŒ
â”‚   â””â”€â”€ vendor_command.py      # å‚å•†å‘½ä»¤æ•°æ®æ ¡éªŒ
â”œâ”€â”€ dao/
â”‚   â”œâ”€â”€ query_template.py      # æŸ¥è¯¢æ¨¡æ¿æ•°æ®è®¿é—®
â”‚   â””â”€â”€ vendor_command.py      # å‚å•†å‘½ä»¤æ•°æ®è®¿é—®
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ query_template.py      # æŸ¥è¯¢æ¨¡æ¿ä¸šåŠ¡é€»è¾‘
â”‚   â””â”€â”€ vendor_command.py      # å‚å•†å‘½ä»¤ä¸šåŠ¡é€»è¾‘
â””â”€â”€ api/v1/
    â”œâ”€â”€ query_templates.py     # æŸ¥è¯¢æ¨¡æ¿APIç«¯ç‚¹
    â””â”€â”€ vendor_commands.py     # å‚å•†å‘½ä»¤APIç«¯ç‚¹
```

## ğŸ”§ æ ¸å¿ƒåŠŸèƒ½å®ç°

### 1. æŸ¥è¯¢æ¨¡æ¿ç®¡ç†

#### æ¨¡æ¿åˆ›å»º
```python
# åˆ›å»ºæŸ¥è¯¢æ¨¡æ¿
template_data = {
    "template_name": "MACåœ°å€æŸ¥è¯¢",
    "template_type": "mac_query",
    "description": "æ ¹æ®MACåœ°å€æŸ¥è¯¢è®¾å¤‡æ¥å£å’Œä½ç½®ä¿¡æ¯",
    "is_active": True
}
```

#### æ¨¡æ¿ç±»å‹æ”¯æŒ
- `mac_query`: MACåœ°å€æŸ¥è¯¢
- `interface_status`: æ¥å£çŠ¶æ€æŸ¥è¯¢
- `vlan_query`: VLANä¿¡æ¯æŸ¥è¯¢
- `route_query`: è·¯ç”±è¡¨æŸ¥è¯¢
- `arp_query`: ARPè¡¨æŸ¥è¯¢
- `cpu_query`: CPUä½¿ç”¨ç‡æŸ¥è¯¢
- `memory_query`: å†…å­˜ä½¿ç”¨ç‡æŸ¥è¯¢

### 2. å‚å•†å‘½ä»¤é€‚é…

#### å¤šå‚å•†å‘½ä»¤é…ç½®
```python
# H3Cè®¾å¤‡å‘½ä»¤
{
    "vendor_id": 1,
    "command_template": "display mac-address {mac_address}",
    "parameters": {
        "mac_address": {
            "type": "string",
            "required": True,
            "pattern": "^([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})$"
        }
    }
}

# åä¸ºè®¾å¤‡å‘½ä»¤
{
    "vendor_id": 2,
    "command_template": "display mac-address {mac_address}",
    "parameters": {
        "mac_address": {
            "type": "string",
            "required": True,
            "pattern": "^([0-9A-Fa-f]{4}-){2}([0-9A-Fa-f]{4})$"
        }
    }
}
```

### 3. å‚æ•°åŒ–æŸ¥è¯¢

#### åŠ¨æ€å‚æ•°æ›¿æ¢
```python
# æ¨¡æ¿å®šä¹‰
command_template = "display interface {interface_name}"

# å‚æ•°ä¼ å…¥
parameters = {"interface_name": "GigabitEthernet1/0/1"}

# ç”Ÿæˆå®é™…å‘½ä»¤
actual_command = "display interface GigabitEthernet1/0/1"
```

#### å‚æ•°éªŒè¯è§„åˆ™
```python
parameters = {
    "mac_address": {
        "type": "string",
        "required": True,
        "pattern": "^([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})$",
        "description": "MACåœ°å€ï¼Œæ ¼å¼ï¼šxx:xx:xx:xx:xx:xx",
        "examples": ["00:1a:2b:3c:4d:5e", "aa-bb-cc-dd-ee-ff"]
    },
    "interface_name": {
        "type": "string",
        "required": True,
        "examples": ["GigabitEthernet1/0/1", "Ten-GigabitEthernet1/0/1"]
    }
}
```

## ğŸ” æƒé™æ§åˆ¶

### æƒé™æšä¸¾å®šä¹‰
```python
class Permissions(str, Enum):
    # æŸ¥è¯¢æ¨¡æ¿æƒé™
    QUERY_TEMPLATE_CREATE = "query_template:create"
    QUERY_TEMPLATE_READ = "query_template:read"
    QUERY_TEMPLATE_UPDATE = "query_template:update"
    QUERY_TEMPLATE_DELETE = "query_template:delete"
    QUERY_TEMPLATE_ACTIVATE = "query_template:activate"
    QUERY_TEMPLATE_ACCESS = "query_template:access"
    
    # å‚å•†å‘½ä»¤æƒé™
    VENDOR_COMMAND_CREATE = "vendor_command:create"
    VENDOR_COMMAND_READ = "vendor_command:read"
    VENDOR_COMMAND_UPDATE = "vendor_command:update"
    VENDOR_COMMAND_DELETE = "vendor_command:delete"
    VENDOR_COMMAND_ACCESS = "vendor_command:access"
```

### APIæƒé™æ§åˆ¶
```python
@router.post("/", response_model=QueryTemplateResponse)
async def create_query_template(
    template_data: QueryTemplateCreate,
    operation_context: OperationContext = Depends(
        require_permission(Permissions.QUERY_TEMPLATE_CREATE)
    )
):
    """åˆ›å»ºæŸ¥è¯¢æ¨¡æ¿"""
    return await query_template_service.create_with_context(
        template_data, operation_context
    )
```

## ğŸ“Š APIæ¥å£æ–‡æ¡£

### æŸ¥è¯¢æ¨¡æ¿ç®¡ç†æ¥å£

| æ–¹æ³• | è·¯å¾„ | æè¿° | æƒé™è¦æ±‚ |
|------|------|------|----------|
| GET | `/api/v1/query-templates` | è·å–æ¨¡æ¿åˆ—è¡¨ | `query_template:read` |
| GET | `/api/v1/query-templates/{id}` | è·å–æ¨¡æ¿è¯¦æƒ… | `query_template:read` |
| POST | `/api/v1/query-templates` | åˆ›å»ºæ¨¡æ¿ | `query_template:create` |
| PUT | `/api/v1/query-templates/{id}` | æ›´æ–°æ¨¡æ¿ | `query_template:update` |
| DELETE | `/api/v1/query-templates/{id}` | åˆ é™¤æ¨¡æ¿ | `query_template:delete` |
| GET | `/api/v1/query-templates/active` | è·å–æ¿€æ´»æ¨¡æ¿ | `query_template:read` |
| GET | `/api/v1/query-templates/type/{type}` | æŒ‰ç±»å‹è·å– | `query_template:read` |
| PUT | `/api/v1/query-templates/{id}/activate` | æ¿€æ´»æ¨¡æ¿ | `query_template:activate` |
| PUT | `/api/v1/query-templates/{id}/deactivate` | åœç”¨æ¨¡æ¿ | `query_template:activate` |
| PUT | `/api/v1/query-templates/batch/activate` | æ‰¹é‡æ¿€æ´» | `query_template:activate` |

### å‚å•†å‘½ä»¤ç®¡ç†æ¥å£

| æ–¹æ³• | è·¯å¾„ | æè¿° | æƒé™è¦æ±‚ |
|------|------|------|----------|
| GET | `/api/v1/vendor-commands` | è·å–å‘½ä»¤åˆ—è¡¨ | `vendor_command:read` |
| GET | `/api/v1/vendor-commands/{id}` | è·å–å‘½ä»¤è¯¦æƒ… | `vendor_command:read` |
| POST | `/api/v1/vendor-commands` | åˆ›å»ºå‘½ä»¤ | `vendor_command:create` |
| PUT | `/api/v1/vendor-commands/{id}` | æ›´æ–°å‘½ä»¤ | `vendor_command:update` |
| DELETE | `/api/v1/vendor-commands/{id}` | åˆ é™¤å‘½ä»¤ | `vendor_command:delete` |
| POST | `/api/v1/vendor-commands/batch` | æ‰¹é‡åˆ›å»º | `vendor_command:create` |
| PUT | `/api/v1/vendor-commands/batch/status` | æ‰¹é‡æ›´æ–°çŠ¶æ€ | `vendor_command:update` |
| DELETE | `/api/v1/vendor-commands/batch` | æ‰¹é‡åˆ é™¤ | `vendor_command:delete` |

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### 1. åˆ›å»ºMACåœ°å€æŸ¥è¯¢æ¨¡æ¿

```python
# 1. åˆ›å»ºæ¨¡æ¿
template_data = {
    "template_name": "MACåœ°å€æŸ¥è¯¢",
    "template_type": "mac_query",
    "description": "æ ¹æ®MACåœ°å€æŸ¥è¯¢è®¾å¤‡æ¥å£å’Œä½ç½®ä¿¡æ¯",
    "is_active": True
}

# 2. é…ç½®H3Cå‘½ä»¤
h3c_command = {
    "template_id": 1,
    "vendor_id": 1,
    "command_template": "display mac-address {mac_address}",
    "parameters": {
        "mac_address": {
            "type": "string",
            "required": True,
            "pattern": "^([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})$"
        }
    }
}

# 3. é…ç½®åä¸ºå‘½ä»¤
huawei_command = {
    "template_id": 1,
    "vendor_id": 2,
    "command_template": "display mac-address {mac_address}",
    "parameters": {
        "mac_address": {
            "type": "string",
            "required": True,
            "pattern": "^([0-9A-Fa-f]{4}-){2}([0-9A-Fa-f]{4})$"
        }
    }
}
```

### 2. æ‰§è¡Œæ¨¡æ¿åŒ–æŸ¥è¯¢

```python
# æŸ¥è¯¢å‚æ•°
query_params = {
    "template_type": "mac_query",
    "device_id": 1,
    "parameters": {
        "mac_address": "00:1a:2b:3c:4d:5e"
    }
}

# ç³»ç»Ÿè‡ªåŠ¨é€‰æ‹©å¯¹åº”å‚å•†çš„å‘½ä»¤æ¨¡æ¿
# H3Cè®¾å¤‡: display mac-address 00:1a:2b:3c:4d:5e
# åä¸ºè®¾å¤‡: display mac-address 001a-2b3c-4d5e
```

### 3. æ‰¹é‡æ“ä½œ

```python
# æ‰¹é‡æ¿€æ´»æ¨¡æ¿
activate_request = {
    "template_ids": [1, 2, 3, 4],
    "reason": "ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²"
}

# æ‰¹é‡åˆ›å»ºå‚å•†å‘½ä»¤
batch_commands = [
    {
        "template_id": 1,
        "vendor_id": 1,
        "command_template": "display interface {interface_name}"
    },
    {
        "template_id": 1,
        "vendor_id": 2,
        "command_template": "display interface {interface_name}"
    }
]
```

## ğŸ” æµ‹è¯•éªŒè¯

### åŠŸèƒ½æµ‹è¯•è¦†ç›–

- âœ… æ¨¡å‹å®šä¹‰å’Œå…³ç³»æ˜ å°„
- âœ… æ•°æ®æ ¡éªŒå’Œçº¦æŸæ£€æŸ¥
- âœ… DAOå±‚æŸ¥è¯¢å’Œæ“ä½œ
- âœ… æœåŠ¡å±‚ä¸šåŠ¡é€»è¾‘
- âœ… APIå±‚æ¥å£å’Œæƒé™
- âœ… å¤šå‚å•†å‘½ä»¤é€‚é…
- âœ… å‚æ•°åŒ–æŸ¥è¯¢æ”¯æŒ
- âœ… æ‰¹é‡æ“ä½œåŠŸèƒ½
- âœ… æƒé™æ§åˆ¶éªŒè¯

### æµ‹è¯•æ–‡ä»¶

- `test_query_template_management.py`: ç»¼åˆåŠŸèƒ½æµ‹è¯•
- `examples/query_template_usage.py`: ä½¿ç”¨ç¤ºä¾‹æ¼”ç¤º

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### æŸ¥è¯¢ä¼˜åŒ–

1. **é¢„åŠ è½½å…³è”æ•°æ®**ï¼šä½¿ç”¨`joinedload`å‡å°‘N+1æŸ¥è¯¢
2. **åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–**ï¼šæ”¯æŒå¤§æ•°æ®é‡çš„é«˜æ•ˆåˆ†é¡µ
3. **ç´¢å¼•ä¼˜åŒ–**ï¼šåœ¨å…³é”®å­—æ®µä¸Šå»ºç«‹ç´¢å¼•
4. **ç¼“å­˜æœºåˆ¶**ï¼šæƒé™ä¿¡æ¯Redisç¼“å­˜

### æ‰¹é‡æ“ä½œä¼˜åŒ–

1. **æ‰¹é‡æ’å…¥**ï¼šä½¿ç”¨`bulk_insert_mappings`æé«˜æ’å…¥æ•ˆç‡
2. **æ‰¹é‡æ›´æ–°**ï¼šä½¿ç”¨`bulk_update_mappings`ä¼˜åŒ–æ›´æ–°æ€§èƒ½
3. **äº‹åŠ¡ç®¡ç†**ï¼šåˆç†ä½¿ç”¨äº‹åŠ¡å‡å°‘é”ç«äº‰

## ğŸ›¡ï¸ å®‰å…¨è€ƒè™‘

### æƒé™æ§åˆ¶

- åŸºäºRBACçš„ç»†ç²’åº¦æƒé™ç®¡ç†
- APIå±‚ç»Ÿä¸€æƒé™éªŒè¯
- æ“ä½œæ—¥å¿—è‡ªåŠ¨è®°å½•

### æ•°æ®éªŒè¯

- è¾“å…¥å‚æ•°ä¸¥æ ¼æ ¡éªŒ
- SQLæ³¨å…¥é˜²æŠ¤
- XSSæ”»å‡»é˜²æŠ¤

### å®¡è®¡è¿½è¸ª

- æ‰€æœ‰æ“ä½œè‡ªåŠ¨è®°å½•æ—¥å¿—
- ç”¨æˆ·æ“ä½œä¸Šä¸‹æ–‡è¿½è¸ª
- æ•°æ®å˜æ›´å†å²ä¿å­˜

## ğŸ”® æ‰©å±•è§„åˆ’

### çŸ­æœŸè§„åˆ’

1. **æ¨¡æ¿ç‰ˆæœ¬ç®¡ç†**ï¼šæ”¯æŒæ¨¡æ¿çš„ç‰ˆæœ¬æ§åˆ¶å’Œå›æ»š
2. **å‘½ä»¤æ‰§è¡Œå¼•æ“**ï¼šé›†æˆå®é™…çš„è®¾å¤‡è¿æ¥å’Œå‘½ä»¤æ‰§è¡Œ
3. **ç»“æœè§£æå™¨**ï¼šæ”¯æŒå¤šç§è¾“å‡ºæ ¼å¼çš„ç»“æ„åŒ–è§£æ

### é•¿æœŸè§„åˆ’

1. **AIè¾…åŠ©ä¼˜åŒ–**ï¼šåŸºäºæ‰§è¡Œå†å²ä¼˜åŒ–å‘½ä»¤æ¨¡æ¿
2. **å¯è§†åŒ–é…ç½®**ï¼šæä¾›å›¾å½¢åŒ–çš„æ¨¡æ¿é…ç½®ç•Œé¢
3. **å¤šç§Ÿæˆ·æ”¯æŒ**ï¼šæ”¯æŒå¤šç§Ÿæˆ·çš„æ¨¡æ¿éš”ç¦»å’Œå…±äº«

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ç½‘ç»œè‡ªåŠ¨åŒ–å¹³å°è®¾è®¡æ–¹æ¡ˆ](./ç½‘ç»œè‡ªåŠ¨åŒ–å¹³å°è®¾è®¡æ–¹æ¡ˆ.md)
- [APIæ–‡æ¡£](./APIæ–‡æ¡£.md)
- [æƒé™ç®¡ç†æ–‡æ¡£](./Redisæƒé™ç¼“å­˜ä½¿ç”¨è¯´æ˜.md)
- [æ•°æ®æ ¡éªŒå±‚æ€»ç»“](./Schemasæ•°æ®æ ¡éªŒå±‚æ€»ç»“.md)

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025-01-29  
**ç»´æŠ¤äººå‘˜**: ç½‘ç»œè‡ªåŠ¨åŒ–å¼€å‘å›¢é˜Ÿ