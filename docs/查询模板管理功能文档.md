# 查询模板管理功能文档

## 📋 功能概述

查询模板管理是网络自动化平台的核心功能之一，旨在解决多厂商网络设备命令差异问题，提供统一的查询接口和模板化的命令管理机制。

### 🎯 核心特性

- **多厂商命令适配**：支持H3C、华为、思科等主流厂商的命令差异
- **模板化参数支持**：动态参数替换，支持复杂查询场景
- **活性控制功能**：灵活的模板启用/禁用管理
- **版本管理机制**：支持模板的版本控制和历史追踪
- **权限控制体系**：基于RBAC的细粒度权限管理
- **批量操作支持**：高效的批量创建、更新、激活操作

## 🏗️ 架构设计

### 数据模型关系

```
QueryTemplate (查询模板)
├── id: 主键
├── template_name: 模板名称
├── template_type: 模板类型
├── description: 描述信息
├── is_active: 激活状态
├── created_at: 创建时间
├── updated_at: 更新时间
└── vendor_commands: 关联的厂商命令列表

VendorCommand (厂商命令)
├── id: 主键
├── template_id: 关联模板ID
├── vendor_id: 厂商ID
├── command_template: 命令模板
├── description: 命令描述
├── parameters: 参数定义(JSON)
├── expected_output_format: 期望输出格式
├── created_at: 创建时间
└── updated_at: 更新时间
```

### 分层架构

```
┌─────────────────┐
│   API Layer    │  ← 权限控制、参数验证、响应格式化
├─────────────────┤
│ Service Layer   │  ← 业务逻辑、操作日志、事务管理
├─────────────────┤
│   DAO Layer     │  ← 数据访问、查询优化、关联查询
├─────────────────┤
│  Model Layer    │  ← 数据模型、关系定义、约束规则
└─────────────────┘
```

## 📁 文件结构

```
app/
├── models/
│   ├── query_template.py      # 查询模板数据模型
│   └── vendor_command.py      # 厂商命令数据模型
├── schemas/
│   ├── query_template.py      # 查询模板数据校验
│   └── vendor_command.py      # 厂商命令数据校验
├── dao/
│   ├── query_template.py      # 查询模板数据访问
│   └── vendor_command.py      # 厂商命令数据访问
├── services/
│   ├── query_template.py      # 查询模板业务逻辑
│   └── vendor_command.py      # 厂商命令业务逻辑
└── api/v1/
    ├── query_templates.py     # 查询模板API端点
    └── vendor_commands.py     # 厂商命令API端点
```

## 🔧 核心功能实现

### 1. 查询模板管理

#### 模板创建
```python
# 创建查询模板
template_data = {
    "template_name": "MAC地址查询",
    "template_type": "mac_query",
    "description": "根据MAC地址查询设备接口和位置信息",
    "is_active": True
}
```

#### 模板类型支持
- `mac_query`: MAC地址查询
- `interface_status`: 接口状态查询
- `vlan_query`: VLAN信息查询
- `route_query`: 路由表查询
- `arp_query`: ARP表查询
- `cpu_query`: CPU使用率查询
- `memory_query`: 内存使用率查询

### 2. 厂商命令适配

#### 多厂商命令配置
```python
# H3C设备命令
{
    "vendor_id": 1,
    "command_template": "display mac-address {mac_address}",
    "parameters": {
        "mac_address": {
            "type": "string",
            "required": True,
            "pattern": "^([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})$"
        }
    }
}

# 华为设备命令
{
    "vendor_id": 2,
    "command_template": "display mac-address {mac_address}",
    "parameters": {
        "mac_address": {
            "type": "string",
            "required": True,
            "pattern": "^([0-9A-Fa-f]{4}-){2}([0-9A-Fa-f]{4})$"
        }
    }
}
```

### 3. 参数化查询

#### 动态参数替换
```python
# 模板定义
command_template = "display interface {interface_name}"

# 参数传入
parameters = {"interface_name": "GigabitEthernet1/0/1"}

# 生成实际命令
actual_command = "display interface GigabitEthernet1/0/1"
```

#### 参数验证规则
```python
parameters = {
    "mac_address": {
        "type": "string",
        "required": True,
        "pattern": "^([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})$",
        "description": "MAC地址，格式：xx:xx:xx:xx:xx:xx",
        "examples": ["00:1a:2b:3c:4d:5e", "aa-bb-cc-dd-ee-ff"]
    },
    "interface_name": {
        "type": "string",
        "required": True,
        "examples": ["GigabitEthernet1/0/1", "Ten-GigabitEthernet1/0/1"]
    }
}
```

## 🔐 权限控制

### 权限枚举定义
```python
class Permissions(str, Enum):
    # 查询模板权限
    QUERY_TEMPLATE_CREATE = "query_template:create"
    QUERY_TEMPLATE_READ = "query_template:read"
    QUERY_TEMPLATE_UPDATE = "query_template:update"
    QUERY_TEMPLATE_DELETE = "query_template:delete"
    QUERY_TEMPLATE_ACTIVATE = "query_template:activate"
    QUERY_TEMPLATE_ACCESS = "query_template:access"
    
    # 厂商命令权限
    VENDOR_COMMAND_CREATE = "vendor_command:create"
    VENDOR_COMMAND_READ = "vendor_command:read"
    VENDOR_COMMAND_UPDATE = "vendor_command:update"
    VENDOR_COMMAND_DELETE = "vendor_command:delete"
    VENDOR_COMMAND_ACCESS = "vendor_command:access"
```

### API权限控制
```python
@router.post("/", response_model=QueryTemplateResponse)
async def create_query_template(
    template_data: QueryTemplateCreate,
    operation_context: OperationContext = Depends(
        require_permission(Permissions.QUERY_TEMPLATE_CREATE)
    )
):
    """创建查询模板"""
    return await query_template_service.create_with_context(
        template_data, operation_context
    )
```

## 📊 API接口文档

### 查询模板管理接口

| 方法 | 路径 | 描述 | 权限要求 |
|------|------|------|----------|
| GET | `/api/v1/query-templates` | 获取模板列表 | `query_template:read` |
| GET | `/api/v1/query-templates/{id}` | 获取模板详情 | `query_template:read` |
| POST | `/api/v1/query-templates` | 创建模板 | `query_template:create` |
| PUT | `/api/v1/query-templates/{id}` | 更新模板 | `query_template:update` |
| DELETE | `/api/v1/query-templates/{id}` | 删除模板 | `query_template:delete` |
| GET | `/api/v1/query-templates/active` | 获取激活模板 | `query_template:read` |
| GET | `/api/v1/query-templates/type/{type}` | 按类型获取 | `query_template:read` |
| PUT | `/api/v1/query-templates/{id}/activate` | 激活模板 | `query_template:activate` |
| PUT | `/api/v1/query-templates/{id}/deactivate` | 停用模板 | `query_template:activate` |
| PUT | `/api/v1/query-templates/batch/activate` | 批量激活 | `query_template:activate` |

### 厂商命令管理接口

| 方法 | 路径 | 描述 | 权限要求 |
|------|------|------|----------|
| GET | `/api/v1/vendor-commands` | 获取命令列表 | `vendor_command:read` |
| GET | `/api/v1/vendor-commands/{id}` | 获取命令详情 | `vendor_command:read` |
| POST | `/api/v1/vendor-commands` | 创建命令 | `vendor_command:create` |
| PUT | `/api/v1/vendor-commands/{id}` | 更新命令 | `vendor_command:update` |
| DELETE | `/api/v1/vendor-commands/{id}` | 删除命令 | `vendor_command:delete` |
| POST | `/api/v1/vendor-commands/batch` | 批量创建 | `vendor_command:create` |
| PUT | `/api/v1/vendor-commands/batch/status` | 批量更新状态 | `vendor_command:update` |
| DELETE | `/api/v1/vendor-commands/batch` | 批量删除 | `vendor_command:delete` |

## 🚀 使用示例

### 1. 创建MAC地址查询模板

```python
# 1. 创建模板
template_data = {
    "template_name": "MAC地址查询",
    "template_type": "mac_query",
    "description": "根据MAC地址查询设备接口和位置信息",
    "is_active": True
}

# 2. 配置H3C命令
h3c_command = {
    "template_id": 1,
    "vendor_id": 1,
    "command_template": "display mac-address {mac_address}",
    "parameters": {
        "mac_address": {
            "type": "string",
            "required": True,
            "pattern": "^([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})$"
        }
    }
}

# 3. 配置华为命令
huawei_command = {
    "template_id": 1,
    "vendor_id": 2,
    "command_template": "display mac-address {mac_address}",
    "parameters": {
        "mac_address": {
            "type": "string",
            "required": True,
            "pattern": "^([0-9A-Fa-f]{4}-){2}([0-9A-Fa-f]{4})$"
        }
    }
}
```

### 2. 执行模板化查询

```python
# 查询参数
query_params = {
    "template_type": "mac_query",
    "device_id": 1,
    "parameters": {
        "mac_address": "00:1a:2b:3c:4d:5e"
    }
}

# 系统自动选择对应厂商的命令模板
# H3C设备: display mac-address 00:1a:2b:3c:4d:5e
# 华为设备: display mac-address 001a-2b3c-4d5e
```

### 3. 批量操作

```python
# 批量激活模板
activate_request = {
    "template_ids": [1, 2, 3, 4],
    "reason": "生产环境部署"
}

# 批量创建厂商命令
batch_commands = [
    {
        "template_id": 1,
        "vendor_id": 1,
        "command_template": "display interface {interface_name}"
    },
    {
        "template_id": 1,
        "vendor_id": 2,
        "command_template": "display interface {interface_name}"
    }
]
```

## 🔍 测试验证

### 功能测试覆盖

- ✅ 模型定义和关系映射
- ✅ 数据校验和约束检查
- ✅ DAO层查询和操作
- ✅ 服务层业务逻辑
- ✅ API层接口和权限
- ✅ 多厂商命令适配
- ✅ 参数化查询支持
- ✅ 批量操作功能
- ✅ 权限控制验证

### 测试文件

- `test_query_template_management.py`: 综合功能测试
- `examples/query_template_usage.py`: 使用示例演示

## 📈 性能优化

### 查询优化

1. **预加载关联数据**：使用`joinedload`减少N+1查询
2. **分页查询优化**：支持大数据量的高效分页
3. **索引优化**：在关键字段上建立索引
4. **缓存机制**：权限信息Redis缓存

### 批量操作优化

1. **批量插入**：使用`bulk_insert_mappings`提高插入效率
2. **批量更新**：使用`bulk_update_mappings`优化更新性能
3. **事务管理**：合理使用事务减少锁竞争

## 🛡️ 安全考虑

### 权限控制

- 基于RBAC的细粒度权限管理
- API层统一权限验证
- 操作日志自动记录

### 数据验证

- 输入参数严格校验
- SQL注入防护
- XSS攻击防护

### 审计追踪

- 所有操作自动记录日志
- 用户操作上下文追踪
- 数据变更历史保存

## 🔮 扩展规划

### 短期规划

1. **模板版本管理**：支持模板的版本控制和回滚
2. **命令执行引擎**：集成实际的设备连接和命令执行
3. **结果解析器**：支持多种输出格式的结构化解析

### 长期规划

1. **AI辅助优化**：基于执行历史优化命令模板
2. **可视化配置**：提供图形化的模板配置界面
3. **多租户支持**：支持多租户的模板隔离和共享

## 📚 相关文档

- [网络自动化平台设计方案](./网络自动化平台设计方案.md)
- [API文档](./API文档.md)
- [权限管理文档](./Redis权限缓存使用说明.md)
- [数据校验层总结](./Schemas数据校验层总结.md)

---

**文档版本**: v1.0  
**最后更新**: 2025-01-29  
**维护人员**: 网络自动化开发团队