# 导入导出服务优化说明

## 优化内容

### 1. 文件存储优化

**之前的问题：**
- 文件存储在项目的 `temp/` 目录中
- 会在项目文件夹中留下临时文件
- 需要手动管理项目目录结构

**优化后：**
- 使用 `tempfile` 模块创建系统临时文件
- 文件自动存储在系统临时目录（如 `C:\Users\xxx\AppData\Local\Temp\`）
- 不会污染项目目录

**代码变化：**
```python
# 之前
filename = f"{self.config.model_name}_import_template.xlsx"
filepath = f"temp/{filename}"
os.makedirs("temp", exist_ok=True)
wb.save(filepath)

# 优化后
with tempfile.NamedTemporaryFile(
    suffix=".xlsx",
    prefix=f"{self.config.model_name}_import_template_",
    delete=False
) as temp_file:
    filepath = temp_file.name
wb.save(filepath)
wb.close()  # 确保工作簿正确关闭
```

### 2. 文件占用问题修复

**之前的问题：**
- Windows上出现 "另一个程序正在使用此文件" 错误
- 文件句柄没有正确关闭
- 临时文件删除失败

**优化后：**
- 使用 `tempfile.mkstemp()` 替代 `NamedTemporaryFile`
- 明确关闭文件描述符
- 添加异常处理避免删除失败
- 使用 `wb.close()` 确保Excel工作簿正确关闭

**代码变化：**
```python
# API层文件处理优化
temp_fd, temp_path = tempfile.mkstemp(suffix=suffix)
try:
    content = await file.read()
    with os.fdopen(temp_fd, 'wb') as temp_file:
        temp_file.write(content)
    # 处理文件...
finally:
    try:
        os.unlink(temp_path)
    except FileNotFoundError:
        pass
    except PermissionError:
        logger.warning(f"无法删除临时文件: {temp_path}")
```

### 3. 自动文件清理

**新增功能：**
- 创建 `TempFileResponse` 类继承 `FileResponse`
- 文件下载完成后自动清理临时文件
- 避免临时文件堆积

**实现：**
```python
class TempFileResponse(FileResponse):
    def __init__(self, *args, cleanup_path: str | None = None, **kwargs):
        super().__init__(*args, **kwargs)
        self.cleanup_path = cleanup_path or self.path
    
    async def __call__(self, scope, receive, send):
        try:
            await super().__call__(scope, receive, send)
        finally:
            # 下载完成后清理临时文件
            if self.cleanup_path and os.path.exists(self.cleanup_path):
                os.unlink(self.cleanup_path)
```

### 4. 资源管理改进

**改进点：**
- 移除不必要的 `os` 导入（因为不再需要创建目录）
- 所有文件操作都有对应的清理逻辑
- 异常处理更加完善
- 资源泄漏风险降到最低

## 使用影响

### 对用户的影响
- **正面影响：** 不会在项目目录中看到临时文件
- **无影响：** API接口保持不变，使用方式完全一样
- **性能提升：** 减少了文件占用错误，提高成功率

### 对开发者的影响
- **简化部署：** 不需要关心临时目录的权限和清理
- **减少维护：** 系统自动管理临时文件
- **提高稳定性：** 解决了Windows平台的文件占用问题

## 注意事项

1. **临时文件位置：** 现在文件存储在系统临时目录中
2. **清理机制：** 文件下载完成后自动删除
3. **异常处理：** 即使删除失败也不会影响功能
4. **兼容性：** 完全兼容现有API，无需修改调用代码

## 测试建议

1. 测试模板下载功能
2. 测试大文件导入导出
3. 测试并发下载
4. 验证临时文件是否正确清理
5. 测试各种文件格式（xlsx, csv）

这些优化解决了原有的文件管理问题，提高了系统的稳定性和用户体验。
