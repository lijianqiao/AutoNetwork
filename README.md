# 网络自动化平台

基于 FastAPI RBAC 架构扩展的现代化网络自动化平台，提供对大规模、多品牌网络设备的统一管理、查询、配置和监控能力。

## 🚀 核心特性

- **多品牌设备支持** - 统一管理 H3C、华为、思科等主流厂商设备，支持不同厂商的Scrapli平台标识。
- **高性能并发操作** - 基于 Scrapli 的异步架构，支持对1000+设备的高效并发操作。
- **智能认证管理** - 支持动态密码（用户手动输入）和静态密码（数据库获取）双重认证模式，包含认证测试和凭据管理。
- **通用查询引擎** - 通过查询模板和厂商命令映射，实现对不同设备命令输出的标准化查询。
- **连接池管理** - 智能连接池，支持连接复用、健康检查、自动重连和连接统计。
- **设备配置管理** - 支持设备配置的备份、快照存储和版本管理。
- **RBAC 权限集成** - 深度集成现有 RBAC 系统，扩展网络自动化相关权限控制。
- **自动化操作日志** - 所有关键操作均自动记录，确保安全合规。

## 📊 开发进度

### ✅ 已完成功能

**第一阶段：核心架构**
- ✅ 权限系统扩展（网络自动化相关权限）
- ✅ 数据模型设计（设备、厂商、基地、查询模板等）
- ✅ DAO层实现（数据访问层）
- ✅ 服务层实现（业务逻辑层）
- ✅ API层实现（RESTful接口）

**第二阶段：网络功能**
- ✅ 设备连接管理（连接池、健康检查）
- ✅ 认证管理系统（动态/静态认证）
- ✅ 认证测试功能（单个/批量测试）
- ✅ 网络查询服务（MAC查询、接口状态、自定义命令）
- ✅ 查询历史记录

**第三阶段：服务层优化**
- ✅ 设备连接服务重构（门面模式，消除功能重复）
- ✅ 查询服务架构统一（NetworkQueryService为单一入口）
- ✅ 统计服务完善（真实运行时间计算，系统监控）
- ✅ 导入导出服务简化（移除过度包装，直接业务实现）

**第四阶段：扩展功能**
- ✅ 导入导出功能（Excel/CSV设备数据批量处理）
- ✅ 系统统计监控（实时运行状态，操作统计）
- ✅ 权限缓存优化（Redis/内存双重缓存，支持热更新）

**第五阶段：交互功能**
- ✅ CLI 交互终端（WebSocket + Xterm.js）
- ✅ 配置对比和恢复
- ✅ 批量操作优化

### 🚧 开发中功能

**第六阶段：高级功能**
- 📋 导入导出功能
- 📋 网络拓扑发现
- 📋 自动化任务调度

**第七阶段：智能化**
- 📋 配置合规性检查
- 📋 智能故障诊断
- 📋 性能监控和告警

## 🌟 技术特色

### 异步高性能架构
- **Scrapli 异步连接** - 支持1000+设备并发操作
- **连接池管理** - 智能连接复用和健康检查
- **批量操作优化** - 支持设备批量认证测试

### 多厂商统一管理
- **查询模板引擎** - 统一不同厂商的命令差异
- **厂商命令映射** - 支持TextFSM解析和自定义解析
- **平台自动识别** - 根据厂商自动选择Scrapli平台

### 智能认证体系
- **认证测试功能** - 单个/批量设备连接测试
- **凭据管理** - 动态/静态密码统一管理
- **认证统计分析** - 成功率、执行时间等统计

## 🚀 未来规划

### 第六阶段：扩展功能
- **网络拓扑发现** - 自动发现和绘制网络拓扑
- **自动化任务调度** - 定时任务和工作流编排
- **设备配置模板** - 标准化配置模板管理

### 第七阶段：智能化
- **配置合规性检查** - 自动化检查设备配置安全基线
- **智能故障诊断** - AI辅助网络故障快速定位
- **性能监控告警** - 设备性能实时监控和告警

## ⚡ 快速开始

```bash
# 创建环境
uv venv --python 3.13

# 安装依赖
uv sync

# 配置环境变量
cp .env.example .env

# 初始化数据库
aerich init-db

# 初始化管理员用户、角色、权限 (环境变量文件可以修改初始化管理员账户的相关信息)
uv run python manage_db.py init

# 运行应用
uv run python start.py
```

访问: http://127.0.0.1:8000/api/docs

## 🧪 测试

项目包含一套完整的测试用例，覆盖了核心的 API 端点和业务逻辑。

```bash
# 运行所有测试
pytest
```

## 🔐 权限系统

### RBAC 模型
- **用户 (User)**: 系统使用者
- **角色 (Role)**: 权限的集合
- **权限 (Permission)**: 具体的操作权限

## 🔒 安全特性

- **JWT Token 认证** - 基于令牌的身份验证
- **权限缓存机制** - Redis/内存双重缓存，支持权限热更新
- **软删除数据保护** - 数据逻辑删除，保护重要信息
- **操作日志审计** - 所有网络操作自动记录审计
- **乐观锁防并发冲突** - 数据版本控制防止并发修改
- **密码加密存储** - 设备认证密码安全加密
- **连接安全控制** - SSH连接加密和超时控制
- **权限精细化控制** - 网络操作权限细分到具体功能
- **CORS 跨域支持** - 安全的跨域访问控制
- **服务层安全设计** - 门面模式隔离核心逻辑，防止直接访问
- **数据导入安全验证** - Excel/CSV导入数据完整性和格式验证

## 🌐 网络设备支持

### 支持的设备品牌
- **H3C (华三)** - hp_comware 平台，占比 85%
- **华为 (Huawei)** - huawei_vrp 平台，占比 10%
- **思科 (Cisco)** - cisco_iosxe 平台，占比 4%
- **其他品牌** - 通用平台支持，占比 1%

### 认证方式
- **动态密码认证** - 用户手动输入，占比 98%
- **静态密码认证** - 数据库存储，占比 2%
- **SNMP 社区字符串** - 按基地统一管理

### 网络架构支持
- **接入层 (Access)** - 终端设备接入
- **汇聚层 (Aggregation)** - 流量汇聚和分发
- **核心层 (Core)** - 高速数据转发

## 📄 许可证

[MIT License](LICENSE)
